name: Release Mobile (Android)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_android:
    name: Build Mobile (Android)
    runs-on: ubuntu-latest
    env:
      PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig
      PKG_CONFIG_ALLOW_SYSTEM_CFLAGS: "1"
      PKG_CONFIG_ALLOW_SYSTEM_LIBS: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install system dependencies (Ubuntu)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            build-essential \
            clang \
            cmake \
            libssl-dev \
            libasound2-dev \
            libglib2.0-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libgdk-pixbuf2.0-dev \
            patchelf
          if ! pkg-config --exists libsoup-3.0; then
            sudo apt-get install -y libsoup-3.0-dev
          fi
          echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_ALLOW_SYSTEM_CFLAGS=1" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_ALLOW_SYSTEM_LIBS=1" >> "$GITHUB_ENV"
          pkg-config --version
          pkg-config --modversion glib-2.0
          pkg-config --modversion gdk-3.0
          pkg-config --modversion libsoup-3.0

      - name: pkg-config debug (Ubuntu)
        shell: bash
        run: |
          set -euo pipefail
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
          pkg-config --debug --modversion libsoup-3.0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager "ndk;26.3.11579264" "platform-tools"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          targets: aarch64-linux-android

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "2.9.6" --locked

      - name: Init Android project
        working-directory: mobile/app
        shell: bash
        run: |
          set -euo pipefail
          export ANDROID_HOME="$ANDROID_SDK_ROOT"
          export NDK_HOME="$ANDROID_SDK_ROOT/ndk/26.3.11579264"
          export CI=true
          if [ ! -d src-tauri/gen/android ]; then
            cargo tauri android init --ci -c ./src-tauri/tauri.conf.json
          fi

      - name: Build Android APK + AAB
        working-directory: mobile/app
        run: |
          export ANDROID_HOME="$ANDROID_SDK_ROOT"
          export NDK_HOME="$ANDROID_SDK_ROOT/ndk/26.3.11579264"
          export CI=true
          cargo tauri android build --target aarch64 --apk true --aab true --ci -c ./src-tauri/tauri.conf.json

      - name: Upload Android artifacts to GitHub Release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          gh release view "${TAG}" >/dev/null 2>&1 || gh release create "${TAG}" --title "${TAG}" --notes "" || true
          shopt -s globstar nullglob
          APK=(mobile/app/src-tauri/gen/android/app/build/outputs/apk/**/*.apk)
          AAB=(mobile/app/src-tauri/gen/android/app/build/outputs/bundle/**/*.aab)
          if [ ${#APK[@]} -eq 0 ] && [ ${#AAB[@]} -eq 0 ]; then
            echo "No Android artifacts found to upload" >&2
            exit 1
          fi
          gh release upload "${TAG}" "${APK[@]}" "${AAB[@]}" --clobber
