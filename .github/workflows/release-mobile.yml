name: Release Mobile (Android)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_android:
    name: Build Mobile (Android)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager "ndk;26.3.11579264" "platform-tools"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.79.0
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2" --locked

      - name: Build Android APK + AAB
        working-directory: mobile/app
        run: |
          export ANDROID_HOME="$ANDROID_SDK_ROOT"
          export NDK_HOME="$ANDROID_SDK_ROOT/ndk/26.3.11579264"
          export CI=true
          cargo tauri android build --apk true --aab true --ci -c ./src-tauri/tauri.conf.json

      - name: Upload Android artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            mobile/app/src-tauri/gen/android/app/build/outputs/apk/**/*.apk
            mobile/app/src-tauri/gen/android/app/build/outputs/bundle/**/*.aab
